name: LLRT CI
on:
  push:
    branches:
      - "main"
  pull_request:

# Only run on the latest ref
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt
      - name: Format
        run: cargo fmt --all -- --check
      - name: Clippy
        run: | #create mock js files
          mkdir -p bundle/js
          for i in {1..5}; do
            echo "console.log(123);" > "bundle/js/test$i.js"
          done
          cargo clippy --all-targets --features "lambda,macro,no-sdk,uncompressed,crypto-rust,tls-ring,openssl-vendored" -- -D warnings

  build:
    needs:
      - check
    strategy:
      fail-fast: ${{ startsWith(github.ref, 'refs/tags/') }}
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - ubuntu-24.04-arm
          - macos-latest
          - macos-14
        crypto:
          - name: default
            features: ""
          - name: crypto-rust+tls-ring
            features: "--no-default-features --features crypto-rust,tls-ring,macro"
          - name: crypto-rust+tls-aws-lc
            features: "--no-default-features --features crypto-rust,tls-aws-lc,macro"
          - name: crypto-ring-rust+tls-ring
            features: "--no-default-features --features crypto-ring-rust,tls-ring,macro"
          - name: crypto-graviola-rust+tls-graviola
            features: "--no-default-features --features crypto-graviola-rust,tls-graviola,macro"
          - name: crypto-openssl+tls-openssl
            features: "--no-default-features --features crypto-openssl,tls-openssl,macro"
        exclude:
          # OpenSSL requires native compilation - exclude from cross-compile targets
          - os: ubuntu-latest
            crypto:
              name: crypto-openssl+tls-openssl
          - os: ubuntu-24.04-arm
            crypto:
              name: crypto-openssl+tls-openssl
          - os: windows-latest
            crypto:
              name: crypto-openssl+tls-openssl
        include:
          - os: windows-latest
            platform: windows
            arch: x86_64
            toolchain: nightly-x86_64-pc-windows-gnu
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            toolchain: nightly
          - os: ubuntu-24.04-arm
            platform: linux
            arch: aarch64
            toolchain: nightly
          - os: macos-latest
            platform: darwin
            arch: x86_64
            toolchain: nightly
          - os: macos-14
            platform: darwin
            arch: aarch64
            toolchain: nightly
    uses: ./.github/workflows/build.yml
    with:
      os: ${{ matrix.os }}
      platform: ${{ matrix.platform }}
      arch: ${{ matrix.arch }}
      toolchain: ${{ matrix.toolchain }}
      cargo_features: ${{ matrix.crypto.features }}

  modules:
    needs:
      - check
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            toolchain: stable
          - os: ubuntu-24.04-arm
            platform: linux
            arch: aarch64
            toolchain: stable
          - os: macos-latest
            platform: darwin
            arch: x86_64
            toolchain: stable
          - os: macos-14
            platform: darwin
            arch: aarch64
            toolchain: stable
          - os: windows-latest
            platform: windows
            arch: x86_64
            toolchain: stable-x86_64-pc-windows-gnu
    uses: ./.github/workflows/build-modules.yml
    with:
      os: ${{ matrix.os }}
      platform: ${{ matrix.platform }}
      arch: ${{ matrix.arch }}
      toolchain: ${{ matrix.toolchain }}
