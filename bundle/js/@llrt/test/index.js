var P=Object.defineProperty;var R=(n,t)=>P(n,"name",{value:t,configurable:!0});import v from"node:net";import _ from"node:os";import{spawn as B}from"node:child_process";import k from"node:path";import{platform as I}from"node:os";var E=class{static{R(this,"CircularBuffer")}buffer;maxSize;currentPosition;isFull;atCapacity;constructor(t,e=t/8){this.maxSize=Math.ceil(t/8)*8;let s=Math.ceil(e/8)*8;this.buffer=Buffer.alloc(s),this.currentPosition=0,this.isFull=!1,this.atCapacity=!1}grow(t){let e=Math.min(Math.pow(2,Math.ceil(Math.log2(t))),this.maxSize);e===this.maxSize&&(this.atCapacity=!0);let s=Buffer.alloc(e);s.set(this.getContent()),this.buffer=s,this.isFull=!1}clear(){this.currentPosition=0,this.isFull=!1}append(t){if(t.length>=this.maxSize){this.atCapacity||(this.buffer=Buffer.alloc(this.maxSize)),this.buffer.set(t.slice(-this.maxSize)),this.currentPosition=0,this.isFull=!0;return}if(!this.atCapacity&&this.currentPosition+t.length>this.buffer.length&&this.grow(this.currentPosition+t.length),this.currentPosition+t.length>=this.buffer.length){let e=this.buffer.length-this.currentPosition;this.buffer.set(t.subarray(0,e),this.currentPosition),this.buffer.set(t.subarray(e)),this.currentPosition=t.length-e,this.isFull=!0}else this.buffer.set(t,this.currentPosition),this.currentPosition+=t.length}getContent(){return this.isFull?Buffer.concat([this.buffer.subarray(this.currentPosition),this.buffer.subarray(0,this.currentPosition)]):this.buffer.subarray(0,this.currentPosition)}};import{dimensions as y}from"llrt:util";var A=I()==="win32",l=class n{static{R(this,"Color")}static colorizer=R((t,e=null,s=null)=>r=>`\x1B[${t||e||s}m${r}${n.RESET}`,"colorizer");static GREEN=n.colorizer(32);static RED=n.colorizer(31);static GREEN_BACKGROUND=n.colorizer(null,42);static RED_BACKGROUND=n.colorizer(null,41);static DIM=n.colorizer(null,null,2);static BOLD=n.colorizer(null,null,1);static CYAN_BOLD=n.colorizer(36,null,1);static RESET="\x1B[0m"},O=class n{static{R(this,"TestServer")}static UPDATE_FPS=15;static UPDATE_INTERVAL_MS=1e3/n.UPDATE_FPS;static DEFAULT_TIMEOUT_MS=parseInt(process.env.TEST_TIMEOUT)||5e3;static DEFAULT_PROGRESS_BAR_WIDTH=24;static SPINNER=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];static TESTING_TEXT=" Testing ";static CHECKMARK="\u2714";static CROSS="\u2718";static ERROR_CODE_SOCKET_ERROR=1;static ERROR_CODE_SOCKET_WRITE_ERROR=2;static ERROR_CODE_PROCESS_ERROR=4;static ERROR_CODE_HANDLE_DATA=8;server=null;workerCount;workerIdBySocket=new Map;testFiles;testFileNames;fileQueue;filesFailed;filesCompleted;completedWorkers=0;workerData={};workerDataFileInProgress=new Map;results=new Map;totalTests=0;totalSuccess=0;totalSkipped=0;totalFailed=0;totalOnly=0;lastUpdate=0;updateInterval=null;spinnerFrameIndex=0;started=0;shutdownPending=!1;constructor(t,{workerCount:e=_.availableParallelism()}={}){this.fileQueue=[...t],this.testFiles=[...t],this.testFileNames=t.map(s=>k.basename(s)),this.filesFailed=new Map,this.filesCompleted=new Set,this.workerCount=Math.min(e,t.length)}async start(){if(this.testFiles.length===0){this.printResults(),this.shutdown();return}this.started=performance.now();let t=v.createServer(e=>this.handleSocketConnected(e));this.server=t,await new Promise(e=>{t.listen(e)}),this.spawnAllWorkers(),this.updateInterval=setInterval(()=>{this.tick()},n.UPDATE_INTERVAL_MS)}handleSocketConnected(t){t.on("data",e=>{let s;try{s=this.handleData(t,e)}catch(r){this.handleError(n.ERROR_CODE_HANDLE_DATA,r);return}t.write(JSON.stringify(s),r=>{if(r)return this.handleError(n.ERROR_CODE_SOCKET_WRITE_ERROR,r,{socket:t});this.shutdownPending&&this.shutdown()})}),t.on("error",e=>{let s=this.workerIdBySocket.get(t);if(!s||!this.workerData[s].completed){if(s){let r=this.workerData[s],a=r.stdErrBuffer.getContent().toString(),i=r.stdOutBuffer.getContent().toString(),o=l.RED_BACKGROUND(l.BOLD(`Worker Error:
`));a&&(o+=l.RED(`
Std Err:
${a}`)),i&&(o+=l.RED(`
Std Out:
${i}`)),console.error(o)}this.handleError(n.ERROR_CODE_SOCKET_ERROR,e,{socket:t})}})}spawnAllWorkers(){for(let t=0;t<this.workerCount;t++)this.workerData[t]={currentTest:null,success:!0,completed:!1,currentResult:null,currentFile:null,currentTimeout:n.DEFAULT_TIMEOUT_MS,lastUpdate:Date.now(),currentPath:[],connectionTimeout:null,stdOutBuffer:new E(1024,64),stdErrBuffer:new E(1024,64)},this.spawnWorker(t)}spawnWorker(t){let e=this.workerData[t],s=e.stdOutBuffer,r=e.stdErrBuffer,a={...process.env,__LLRT_TEST_SERVER_PORT:(this.server?.address()).port,__LLRT_TEST_WORKER_ID:t.toString()};delete a.LLRT_LOG;let i=B(process.argv0,["-e",'import("llrt:test/worker").catch(console.error)'],{env:a});i.stderr.on("data",o=>{r.append(o)}),i.stdout.on("data",o=>{s.append(o)}),i.on("error",o=>{this.handleError(n.ERROR_CODE_PROCESS_ERROR,o,{id:t,ended:performance.now()})}),i.on("exit",o=>{o!=0&&(this.handleError(n.ERROR_CODE_PROCESS_ERROR,new Error("Worker process exited with a non-zero exit code"),{id:t,ended:performance.now()}),this.handleWorkerCompleted(t,!0))}),e.connectionTimeout=setTimeout(()=>{i.kill()},5e3),e.childProc=i}handleError(t,e,s){switch(t){case n.ERROR_CODE_HANDLE_DATA:console.error("Error handling data,",e),process.exit(1);case n.ERROR_CODE_SOCKET_WRITE_ERROR:case n.ERROR_CODE_SOCKET_ERROR:console.error("Socket error,",e),process.exit(1);case n.ERROR_CODE_PROCESS_ERROR:{let{id:r,ended:a}=s;this.handleTestError(r,e,a);break}}}handleData(t,e){let s=JSON.parse(e),{type:r}=s,a=this.workerIdBySocket.get(t);switch(a&&(this.workerData[a].lastUpdate=Date.now()),r){case"ready":{let{workerId:i}=s;this.workerIdBySocket.set(t,i),clearTimeout(this.workerData[i].connectionTimeout);break}case"module":{let{testCount:i,skipCount:o,onlyCount:d}=s;this.totalTests+=i,this.totalSkipped+=o,this.totalOnly+=d;break}case"next":{let i=this.fileQueue.shift(),o=this.workerData[a];return o.stdErrBuffer.clear(),o.stdOutBuffer.clear(),o.currentPath.length=0,i?(this.results.set(i,{results:[],name:k.basename(i),success:!0,started:0,ended:0,printed:!1}),o.currentFile=i,this.workerDataFileInProgress.set(i,o)):(o.currentFile=null,o.lastUpdate=0),{nextFile:i||null}}case"start":{let{desc:i,isSuite:o,started:d,timeout:h}=s,u=this.workerData[a];if(u.currentTimeout=h||n.DEFAULT_TIMEOUT_MS,o){let c={desc:i,tests:[],success:!0,children:[],parent:u.currentResult,started:0,ended:0};if(c.parent)u.currentResult.children.push(c);else{let p=this.results.get(u.currentFile);p.started=d,p.results.push(c)}u.currentResult=c}else{let c={desc:i,success:!0,started:d,ended:0,error:null};u.currentResult.tests.push(c),u.currentTest=c}u.currentPath.push(i);break}case"end":{let{isSuite:i,ended:o,started:d}=s,h=this.workerData[a],u=h.currentResult;if(h.lastUpdate=0,i){if(u.ended=o,u.started=d,h.currentResult=u.parent,!h.currentResult){let c=this.results.get(h.currentFile);c.ended=o,c.started=d,h.success&&this.filesCompleted.add(h.currentFile)}}else{this.totalSuccess++;let c=h.currentTest;c.ended=o,c.success=!0}h.currentPath.pop();break}case"error":{let{error:i,ended:o}=s;this.handleTestError(a,i,o);break}case"completed":{this.handleWorkerCompleted(a,!1);break}default:throw new Error("Unknown type")}return null}handleWorkerCompleted(t,e){this.workerData[t].completed=!0,this.completedWorkers++,this.completedWorkers==this.workerCount&&(clearInterval(this.updateInterval),this.tick(),this.printResults(),e?this.shutdown():this.shutdownPending=!0)}shutdown(){this.shutdownPending=!1,this.server?.close(()=>{A&&process.exit(0)})}handleTestError(t,e,s){let r=this.workerData[t],a=r.currentTest||{desc:"",success:!1,started:0,ended:0,error:e};r.success=!1;let i=this.results.get(r.currentFile);i&&(i.success=!1);let o=this.filesFailed.get(r.currentFile)||[];o.push({desc:r.currentPath.slice(1),error:e,stdErr:r.stdErrBuffer.getContent().toString(),stdOut:r.stdOutBuffer.getContent().toString()}),r.stdErrBuffer.clear(),r.stdOutBuffer.clear(),this.filesFailed.set(r.currentFile,o),this.totalFailed++,a.ended=s,a.error=e,a.success=!1,r.currentPath.pop()}tick(){let t=Date.now(),e=this.lastUpdate==0;t-this.lastUpdate>n.UPDATE_INTERVAL_MS&&(this.spinnerFrameIndex=(this.spinnerFrameIndex+1)%n.SPINNER.length,this.lastUpdate=t);for(let s in this.workerData){let r=this.workerData[s];!r.completed&&r.lastUpdate>0&&t-r.lastUpdate>=r.currentTimeout&&(this.handleTestError(s,new Error(`Test timed out after ${r.currentTimeout}ms`),performance.now()),r.childProc?.kill(),this.handleWorkerCompleted(parseInt(s),!0))}if(this.completedWorkers!=this.workerCount){let[s]=y(),r="";e||(r="\x1B[F\x1B[2K");let a=n.SPINNER[this.spinnerFrameIndex];s>80&&(s=80);let i=this.testFiles.length,o=(this.filesCompleted.size+this.filesFailed.size)/i,d=`${this.totalSuccess}/${this.totalTests}`,h=Math.min(n.DEFAULT_PROGRESS_BAR_WIDTH,Math.max(10,s-(2+d.length+2))),u=h,c=u==n.DEFAULT_PROGRESS_BAR_WIDTH;c&&(u+=n.TESTING_TEXT.length);let p=!1,w=!1,T=0,f="",g=!1;for(let m of this.testFiles){let S=this.results.get(m);if(p=this.filesCompleted.has(m),p||(w=this.filesFailed.has(m)),S&&(p||w)){S.printed||(S.printed=!0,r+=p?l.GREEN(n.CHECKMARK):l.RED(n.CROSS),r+=" ",r+=S.name,r+=`
`),T++;continue}let F=this.workerDataFileInProgress.has(m),D=this.testFileNames[T];F&&u+f.length+4<s&&(u+f.length+D.length+4<s?(f+=D,f+=", "):(g=!0,f+=D.slice(0,s-(u+f.length+5)),f+="...")),T++}g||(f=f.slice(0,-2));let C=Math.floor(h*o),b=h-C;r+=a,c&&(r+=l.CYAN_BOLD(n.TESTING_TEXT)),r+=`[${"=".repeat(C)}${"-".repeat(b)}]`,r+=d,r+=": ",r+=l.DIM(f),console.log(r)}}printResults(){let t=performance.now(),e="";for(let s of this.testFiles){let r=this.results.get(s);e+=`${r.success?l.GREEN_BACKGROUND(l.BOLD(" PASS ")):l.RED_BACKGROUND(l.BOLD(" FAIL "))} ${r.name} ${l.DIM(n.elapsed(r))}
`;for(let a of r.results)e+=this.printSuiteResult(a);e+=`
`}if(this.totalFailed==0?e+=l.GREEN_BACKGROUND(l.BOLD(` ${n.CHECKMARK} ALL PASS `)):e+=l.RED_BACKGROUND(l.BOLD(` ${n.CHECKMARK} TESTS FAILED `)),e+=` ${l.DIM(n.elapsed({started:this.started,ended:t}))}
`,e+=`${this.totalSuccess} passed, ${this.totalFailed} failed, ${this.totalSkipped} skipped, ${this.totalTests} tests
`,console.log(e),this.totalFailed>0){e="";let s=new Map(Array.from(this.filesFailed.entries()).sort(([r],[a])=>r.localeCompare(a)));for(let[r,a]of s){e+=`
${l.RED_BACKGROUND(` ${r} `)}
`;for(let i of a)e+=i.desc.map(o=>l.BOLD(o)).join(" > ")+`
${this.formattedError(i.error)}
`,i.stdOut&&(e+=`----- LAST STDOUT: -----
`+i.stdOut+`
`),i.stdErr&&(e+=`----- LAST STDERR: -----
`+i.stdErr+`
`)}process.exitCode=1}console.error(e)}printSuiteResult(t,e=0){let s="",r="  ".repeat(e);for(let i of t.tests){let o=i.success?l.GREEN(n.CHECKMARK):l.RED(n.CROSS);s+=`${r}${o} ${i.desc} ${l.DIM(n.elapsed(i))}
`,i.error&&(s+=this.formattedError(i.error)+`
`)}let a=t.children;for(let i of a)s+=`${r}${l.BOLD(i.desc)} ${l.DIM(n.elapsed(i))}
`,s+=this.printSuiteResult(i,e+1);return s}formattedError(t,e=""){let s=t.stack||"";return e&&s&&(s=s.split(`
`).map(r=>e+r).join(`
`)),l.RED(`${e}\x1B[1m${t.name}:\x1B[22m ${t.message}
${s}`)}static elapsed({started:t,ended:e}){return`${(e-t).toFixed(3)}ms`}},M=new O(globalThis.__testEntries,{workerCount:void 0});await M.start();
